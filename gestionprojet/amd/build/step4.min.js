define(["jquery","mod_gestionprojet/autosave","core/str","core/notification","core/ajax"],function(l,o,e,t,s){return{init:function(e){var t=e.cmid,n=e.step,i=e.groupid,r=e.autosaveInterval,u=e.isLocked,a=e.strings||{},d=e.interacteurs||[];function c(e){s.call([{methodname:"mod_gestionprojet_submit_step",args:{cmid:t,step:n,action:e}}])[0].done(function(e){e.success?window.location.reload():alert("Error: "+(e.message||"Unknown error"))}).fail(function(e){console.error("Submission error",e)})}function m(){let c=document.getElementById("interactorsContainer");c.innerHTML="",d.forEach((e,l)=>{var t,n=document.createElement("div"),i=(n.className="interactor-item",document.createElement("div"));i.className="interactor-header";let r=document.createElement("input"),a=(r.type="text",r.className="interactor-name-input",r.value=e.name,r.placeholder="Nom de l'interacteur",(r.readOnly=u)||(r.onchange=()=>{d[l].name=r.value,p()}),i.appendChild(r),!u&&2<=l&&((t=document.createElement("button")).type="button",t.className="btn-delete-interactor",t.innerHTML="ðŸ—‘ï¸ Supprimer",t.onclick=()=>{d.splice(l,1),m(),p()},i.appendChild(t)),n.appendChild(i),document.createElement("div"));a.className="fc-list",e.fcs.forEach((c,o)=>{var e=document.createElement("div"),t=(e.className="fc-item",document.createElement("div"));t.className="fc-header",t.innerHTML='<span class="fc-label">FC'+(o+1)+"</span>",e.appendChild(t);let n=document.createElement("input"),s=(n.type="text",n.className="fc-value-input",n.value=c.value,n.placeholder="Description de la fonction contrainte",(n.readOnly=u)||(n.onchange=()=>{d[l].fcs[o].value=n.value,p()}),e.appendChild(n),document.createElement("div"));s.className="criteres-list",c.criteres&&c.criteres.forEach((e,t)=>{var n=document.createElement("div");n.className="critere-item";let i=document.createElement("input"),r=(i.type="text",i.className="critere-input",i.value=e.critere,i.placeholder="CritÃ¨re d'apprÃ©ciation",(i.readOnly=u)||(i.onchange=()=>{d[l].fcs[o].criteres[t].critere=i.value}),document.createElement("input")),a=(r.type="text",r.className="critere-input",r.value=e.niveau,r.placeholder="Niveau",(r.readOnly=u)||(r.onchange=()=>{d[l].fcs[o].criteres[t].niveau=r.value}),document.createElement("input"));a.type="text",a.className="critere-input",a.value=e.unite,a.placeholder="UnitÃ©",(a.readOnly=u)||(a.onchange=()=>{d[l].fcs[o].criteres[t].unite=a.value}),n.appendChild(i),n.appendChild(r),n.appendChild(a),u||((e=document.createElement("button")).type="button",e.className="btn-remove",e.innerHTML="âœ•",e.onclick=()=>{1<c.criteres.length&&(d[l].fcs[o].criteres.splice(t,1),m())},n.appendChild(e)),s.appendChild(n)}),e.appendChild(s),u||((t=document.createElement("button")).type="button",t.className="btn-add",t.innerHTML="+ CritÃ¨re",t.onclick=()=>{d[l].fcs[o].criteres||(d[l].fcs[o].criteres=[]),d[l].fcs[o].criteres.push({critere:"",niveau:"",unite:""}),m()},e.appendChild(t)),a.appendChild(e)}),n.appendChild(a),u||((t=document.createElement("button")).type="button",t.className="btn-add",t.innerHTML="+ Fonction Contrainte",t.onclick=()=>{d[l].fcs.push({value:"",criteres:[{critere:"",niveau:"",unite:""}]}),m(),p()},n.appendChild(t)),c.appendChild(n)})}function p(){let s=document.getElementById("interactorDiagram");if(s){s.innerHTML="",s.setAttribute("viewBox","0 0 800 500");let a=400,c=250;var e=d.filter(e=>e.name&&""!==e.name.trim());let o=2*Math.PI/e.length;e.forEach((e,t)=>{var n=t*o-Math.PI/2,i=a+200*Math.cos(n),n=c+200*Math.sin(n),r=document.createElementNS("http://www.w3.org/2000/svg","line"),r=(r.setAttribute("x1",i),r.setAttribute("y1",n),r.setAttribute("x2",a),r.setAttribute("y2",c),r.setAttribute("stroke",t<2?"#667eea":"#ff6b6b"),r.setAttribute("stroke-width",t<2?"3":"2"),s.appendChild(r),document.createElementNS("http://www.w3.org/2000/svg","circle")),r=(r.setAttribute("cx",i),r.setAttribute("cy",n),r.setAttribute("r","40"),r.setAttribute("fill","#f0f3ff"),r.setAttribute("stroke","#667eea"),r.setAttribute("stroke-width","2"),s.appendChild(r),document.createElementNS("http://www.w3.org/2000/svg","text"));r.setAttribute("x",i),r.setAttribute("y",n),r.setAttribute("text-anchor","middle"),r.setAttribute("dominant-baseline","middle"),r.setAttribute("font-size","12"),r.setAttribute("fill","#333"),r.textContent=e.name,s.appendChild(r),2<=t&&e.fcs&&e.fcs[0]&&e.fcs[0].value&&((r=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",(i+a)/2),r.setAttribute("y",(n+c)/2-10),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","11"),r.setAttribute("fill","#ff6b6b"),r.setAttribute("font-weight","bold"),r.textContent="FC"+(t-1),s.appendChild(r))});var e=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),e=(e.setAttribute("cx",a),e.setAttribute("cy",c),e.setAttribute("rx",90),e.setAttribute("ry",60),e.setAttribute("fill","#667eea"),e.setAttribute("stroke","#764ba2"),e.setAttribute("stroke-width","3"),s.appendChild(e),l("#produit").val()||"Produit"),t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("x",a),t.setAttribute("y",c),t.setAttribute("text-anchor","middle"),t.setAttribute("dominant-baseline","middle"),t.setAttribute("font-size","16"),t.setAttribute("font-weight","bold"),t.setAttribute("fill","white"),t.textContent=e,s.appendChild(t)}}0===d.length&&(d=[{name:"Utilisateur",fcs:[]},{name:"Milieu extÃ©rieur",fcs:[]}]),l("#addInteractorBtn").on("click",function(){d.push({name:"Interacteur "+(d.length+1),fcs:[{value:"",criteres:[{critere:"",niveau:"",unite:""}]}]}),m(),p()}),l("#exportPdfBtn").on("click",function(){alert(a.export_pdf_coming_soon||"Export PDF coming soon")}),l("#produit").on("change",function(){p()}),l("#submitButton").on("click",function(){confirm(a.confirm_submission)&&c("submit")}),l("#revertButton").on("click",function(){confirm(a.confirm_revert)&&c("revert")});m(),p(),u||o.init({cmid:t,step:n,groupid:i,interval:r,formSelector:"#cdcfForm",serialize:function(){var e={};return l("#cdcfForm").find('input[type="text"], textarea').each(function(){this.name&&(e[this.name]=this.value)}),e.interacteurs_data=JSON.stringify(d),e}})}}});