/**
 * Autosave functionality for gestionprojet.
 *
 * @module     mod_gestionprojet/autosave
 * @copyright  2026 Emmanuel REMY
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/str","mod_gestionprojet/toast"],function(e,t,s,i,o){return{cmid:0,step:0,groupid:0,mode:"",interval:3e4,debounceDelay:2e3,debounceTimer:null,timer:null,formSelector:null,statusElement:null,isDirty:!1,serialize:null,onSave:null,strings:{},init:function(e){this.cmid=e.cmid,this.step=e.step||0,this.groupid=e.groupid||0,this.mode=e.mode||"",this.interval=e.interval||3e4,this.formSelector=e.formSelector||"form","function"==typeof e.serialize&&(this.serialize=e.serialize),"function"==typeof e.onSave&&(this.onSave=e.onSave);var t=this;i.get_strings([{key:"autosave_status_default",component:"mod_gestionprojet"},{key:"autosave_status_saving",component:"mod_gestionprojet"},{key:"autosave_status_saved",component:"mod_gestionprojet"},{key:"autosave_status_error",component:"mod_gestionprojet"},{key:"autosave_unsaved_changes",component:"mod_gestionprojet"}]).then(function(e){t.strings={defaultText:e[0],saving:e[1],saved:e[2],error:e[3],unsavedChanges:e[4]},t.createStatusIndicator(),t.monitorChanges(),t.startTimer(),t.setupBeforeUnload()}).catch(s.exception)},createStatusIndicator:function(){},monitorChanges:function(){var t=this;e(document).on("change input",this.formSelector+" input, "+this.formSelector+" textarea, "+this.formSelector+" select",function(){t.isDirty=!0,clearTimeout(t.debounceTimer),t.debounceTimer=setTimeout(function(){t.save()},t.debounceDelay)})},startTimer:function(){var e=this;this.timer=setInterval(function(){e.isDirty&&e.save()},this.interval)},stopTimer:function(){this.timer&&(clearInterval(this.timer),this.timer=null)},showStatus:function(e){switch(e){case"saving":o.info(this.strings.saving||"Saving...",2e3);break;case"saved":o.success(this.strings.saved||"Saved",2e3);break;case"error":o.error(this.strings.error||"Save error",5e3)}},save:function(){var s=this;if(this.step){clearTimeout(this.debounceTimer),this.showStatus("saving");var i={};this.serialize?i=this.serialize():e(this.formSelector).find("input, textarea, select").each(function(){var t=e(this),s=t.attr("name"),o=t.attr("type");s&&(s.endsWith("[]")||("checkbox"===o?i[s]=t.is(":checked")?1:0:"radio"===o?t.is(":checked")&&(i[s]=t.val()):i[s]=t.val()))});var o={cmid:this.cmid,step:this.step,data:JSON.stringify(i),groupid:this.groupid,mode:this.mode||""};t.call([{methodname:"mod_gestionprojet_autosave",args:o}])[0].done(function(e){e.success?(s.isDirty=!1,s.showStatus("saved"),s.onSave&&s.onSave(e)):(s.showStatus("error"),e.message&&console.error("Autosave error:",e.message))}).fail(function(e){s.showStatus("error"),console.error("Autosave connection error:",e.message||e)})}},setupBeforeUnload:function(){var t=this;e(window).on("beforeunload",function(){if(t.isDirty)return t.save(),t.strings.unsavedChanges||"You have unsaved changes."})}}});