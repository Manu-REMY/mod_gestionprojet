/**
 * Grading page interactions for mod_gestionprojet.
 *
 * Handles toggle sections, AI trigger/apply/retry buttons,
 * unlock submission, bulk reevaluate, and auto-reload for pending evaluations.
 *
 * @module     mod_gestionprojet/grading
 * @copyright  2026 Emmanuel REMY
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["core/ajax","core/notification"],function(e,t){var n={};function r(e,t){var n,r=[];for(n=0;n<e.childNodes.length;n++)r.push(e.childNodes[n].cloneNode(!0));for(e.disabled=!0;e.firstChild;)e.removeChild(e.firstChild);var i=document.createElement("span");return i.className="spinner-border spinner-border-sm",i.setAttribute("role","status"),e.appendChild(i),e.appendChild(document.createTextNode(" "+(t||"..."))),r}function i(e,t){for(e.disabled=!1;e.firstChild;)e.removeChild(e.firstChild);var n;for(n=0;n<t.length;n++)e.appendChild(t[n])}return{init:function(t){var a,s,o,d,c,l,u;(n=t||{}).strings=n.strings||{},document.addEventListener("click",function(e){var t=e.target.closest(".ai-section-toggle");t&&(e.preventDefault(),function(e){e.classList.toggle("collapsed");var t=e.nextElementSibling;t&&t.classList.toggle("collapsed")}(t))}),(a=document.getElementById("btn-trigger-ai-eval"))&&a.addEventListener("click",function(){var e=this;"undefined"!=typeof require&&require(["mod_gestionprojet/ai_progress"],function(t){t.triggerEvaluation(parseInt(e.dataset.cmid),parseInt(e.dataset.step),parseInt(e.dataset.submissionid))})}),(s=document.getElementById("btn-apply-ai-grade"))&&s.addEventListener("click",function(){var e=this;"undefined"!=typeof require&&require(["mod_gestionprojet/ai_progress"],function(t){t.applyGrade(parseInt(e.dataset.cmid),parseInt(e.dataset.evaluationid))})}),(o=document.getElementById("btn-retry-ai-eval"))&&o.addEventListener("click",function(){"undefined"!=typeof require&&require(["mod_gestionprojet/ai_progress"],function(e){e.retryEvaluation(n.cmid,n.step,n.submissionid)})}),(d=document.querySelector(".btn-ai-modify"))&&d.addEventListener("click",function(){var e=document.getElementById("grade"),t=document.getElementById("feedback");e&&(e.value=this.dataset.grade||""),t&&(t.value=this.dataset.feedback||""),e&&e.focus()}),(c=document.getElementById("btn-unlock-submission"))&&c.addEventListener("click",function(){var t=n.strings.confirm_unlock||"Are you sure?";if(confirm(t)){var a=this,s=r(a,"...");e.call([{methodname:"mod_gestionprojet_submit_step",args:{cmid:parseInt(a.dataset.cmid),step:parseInt(a.dataset.step),action:"unlock"}}])[0].done(function(e){if(e.success)location.reload();else{var t=n.strings.error||"Error";alert(e.message||t),i(a,s)}}).fail(function(){var e=n.strings.network_error||"Network error";alert(e),i(a,s)})}}),(l=document.getElementById("btn-bulk-reevaluate"))&&l.addEventListener("click",function(){var t=n.strings.confirm_bulk||"Are you sure?";if(confirm(t)){var a=this,s=n.strings.bulk_processing||"Processing...",o=r(a,s);e.call([{methodname:"mod_gestionprojet_bulk_reevaluate",args:{cmid:parseInt(a.dataset.cmid),step:parseInt(a.dataset.step)}}])[0].done(function(e){if(e.success)alert(e.message),location.reload();else{var t=n.strings.error||"Error";alert(e.message||t),i(a,o)}}).fail(function(){var e=n.strings.network_error||"Network error";alert(e),i(a,o)})}}),(u=document.getElementById("grading-item-selector"))&&u.addEventListener("change",function(){this.value&&(window.location.href=this.value)}),function(){var e=document.querySelector(".ai-pending[data-auto-reload]");if(e){var t=parseInt(e.dataset.autoReload)||1e4;setTimeout(function(){location.reload()},t)}}()}}});