define(["jquery","core/ajax","core/notification"],function(l,d,p){return{cmid:0,step:0,submissionid:0,evaluationid:0,pollInterval:5e3,pollTimer:null,maxPolls:60,pollCount:0,containerSelector:"#ai-progress-container",onComplete:null,onError:null,init:function(s){this.cmid=s.cmid,this.step=s.step||0,this.submissionid=s.submissionid||0,this.evaluationid=s.evaluationid||0,this.pollInterval=s.pollInterval||5e3,this.containerSelector=s.containerSelector||"#ai-progress-container",this.onComplete=s.onComplete||null,this.onError=s.onError||null,this.createProgressUI(),this.bindEvents()},createProgressUI:function(){var s=l(this.containerSelector);s.length&&(s.append('<div id="ai-progress-overlay" style="display: none;"><div class="ai-progress-modal"><div class="ai-progress-header"><span class="ai-progress-icon">ü§ñ</span><span class="ai-progress-title">√âvaluation IA en cours</span></div><div class="ai-progress-body"><div class="ai-progress-spinner"></div><div class="ai-progress-status">Initialisation...</div><div class="ai-progress-bar-container"><div class="ai-progress-bar"></div></div><div class="ai-progress-details"></div></div></div></div>'),this.injectStyles())},injectStyles:function(){l("#ai-progress-styles").length||l("head").append('<style id="ai-progress-styles">#ai-progress-overlay {  position: fixed; top: 0; left: 0; width: 100%; height: 100%;  background: rgba(0, 0, 0, 0.5); z-index: 10000;  display: flex; align-items: center; justify-content: center;}.ai-progress-modal {  background: white; border-radius: 12px; padding: 30px;  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);  min-width: 400px; max-width: 90%; text-align: center;}.ai-progress-header {  display: flex; align-items: center; justify-content: center;  gap: 12px; margin-bottom: 20px;}.ai-progress-icon {  font-size: 2em;}.ai-progress-title {  font-size: 1.25em; font-weight: 600; color: #1a56db;}.ai-progress-spinner {  width: 50px; height: 50px; margin: 20px auto;  border: 4px solid #e5e7eb; border-top-color: #1a56db;  border-radius: 50%; animation: ai-spin 1s linear infinite;}@keyframes ai-spin {  to { transform: rotate(360deg); }}.ai-progress-status {  font-size: 1.1em; color: #374151; margin: 15px 0;}.ai-progress-bar-container {  background: #e5e7eb; border-radius: 10px; height: 8px;  overflow: hidden; margin: 20px 0;}.ai-progress-bar {  background: linear-gradient(90deg, #1a56db, #3b82f6);  height: 100%; width: 0%; transition: width 0.5s ease;  border-radius: 10px;}.ai-progress-details {  font-size: 0.85em; color: #6b7280; margin-top: 10px;}.ai-progress-inline {  display: inline-flex; align-items: center; gap: 8px;  padding: 8px 16px; background: #f0f4ff; border-radius: 8px;  border: 1px solid #c2d6ff;}.ai-progress-inline .spinner-small {  width: 16px; height: 16px; border: 2px solid #e5e7eb;  border-top-color: #1a56db; border-radius: 50%;  animation: ai-spin 1s linear infinite;}.ai-status-badge {  display: inline-flex; align-items: center; gap: 6px;  padding: 6px 12px; border-radius: 6px; font-size: 0.9em;}.ai-status-pending { background: #fef3c7; color: #92400e; }.ai-status-processing { background: #dbeafe; color: #1e40af; }.ai-status-completed { background: #d1fae5; color: #065f46; }.ai-status-failed { background: #fee2e2; color: #991b1b; }.ai-status-applied { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }</style>')},bindEvents:function(){var e=this;l(document).on("click",".btn-trigger-ai-eval",function(s){s.preventDefault();s=l(this);e.triggerEvaluation(s.data("cmid"),s.data("step"),s.data("submissionid"))}),l(document).on("click",".btn-apply-ai-grade",function(s){s.preventDefault();s=l(this);e.applyGrade(s.data("cmid"),s.data("evaluationid"))}),l(document).on("click",".btn-retry-ai-eval",function(s){s.preventDefault();s=l(this);e.retryEvaluation(s.data("cmid"),s.data("step"),s.data("submissionid"))})},showProgress:function(s){l("#ai-progress-overlay").fadeIn(200),this.updateStatus(s||"Initialisation..."),this.updateProgressBar(10)},hideProgress:function(){l("#ai-progress-overlay").fadeOut(200),this.stopPolling()},updateStatus:function(s){l(".ai-progress-status").text(s)},updateProgressBar:function(s){l(".ai-progress-bar").css("width",Math.min(s,100)+"%")},updateDetails:function(s){l(".ai-progress-details").html(s)},triggerEvaluation:function(s,e,i){var t=this;this.cmid=s,this.step=e,this.submissionid=i,this.showProgress("Envoi de la demande d'√©valuation..."),this.updateProgressBar(20),d.call([{methodname:"mod_gestionprojet_evaluate",args:{cmid:s,step:e,submissionid:i}}])[0].done(function(s){s.success?(t.evaluationid=s.evaluationid,t.updateStatus("√âvaluation en cours..."),t.updateProgressBar(30),t.startPolling()):t.showError(s.message||"Erreur lors du d√©clenchement")}).fail(function(s){t.showError(s.message||"Erreur de connexion au serveur")})},retryEvaluation:function(s,e,i){this.triggerEvaluation(s,e,i)},startPolling:function(){var s=this;this.pollCount=0,this.pollTimer=setInterval(function(){s.checkStatus()},this.pollInterval)},stopPolling:function(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)},checkStatus:function(){var e=this,s=(this.pollCount++,Math.min(30+2*this.pollCount,90));this.updateProgressBar(s),this.pollCount>=this.maxPolls?(this.stopPolling(),this.showError("D√©lai d'attente d√©pass√©. Veuillez r√©essayer.")):(s={cmid:this.cmid,evaluationid:0,step:0,submissionid:0},this.evaluationid?s.evaluationid=this.evaluationid:(s.step=this.step,s.submissionid=this.submissionid),d.call([{methodname:"mod_gestionprojet_get_evaluation_status",args:s}])[0].done(function(s){s.success&&s.has_evaluation?e.handleStatusUpdate(s):s.success||e.showError(s.error_message||s.status_label||"Erreur de r√©cup√©ration du statut")}).fail(function(){console.warn("Network error while polling AI status")}))},handleStatusUpdate:function(s){var e=s.status;this.updateStatus(s.status_label||e),"completed"===e||"applied"===e?(this.updateProgressBar(100),this.stopPolling(),setTimeout(function(){location.reload()},500)):"failed"===e?(this.stopPolling(),this.showError(s.error_message||"L'√©valuation a √©chou√©")):this.updateDetails("Temps √©coul√©: "+Math.round(this.pollCount*this.pollInterval/1e3)+"s")},showError:function(s){this.hideProgress(),p.addNotification({message:s,type:"error"}),this.onError&&this.onError(s)},applyGrade:function(s,e){var i=this,t=(this.showProgress("Application de la note..."),this.updateProgressBar(50),l("#show_feedback").is(":checked")?1:0),a=l("#show_criteria").is(":checked")?1:0,o=l("#show_keywords_found").is(":checked")?1:0,r=l("#show_keywords_missing").is(":checked")?1:0,n=l("#show_suggestions").is(":checked")?1:0;d.call([{methodname:"mod_gestionprojet_apply_ai_grade",args:{cmid:s,evaluationid:e,show_feedback:t,show_criteria:a,show_keywords_found:o,show_keywords_missing:r,show_suggestions:n}}])[0].done(function(s){s.success?(i.updateStatus("Note appliqu√©e !"),i.updateProgressBar(100),p.addNotification({message:"La note IA a √©t√© appliqu√©e avec succ√®s",type:"success"}),setTimeout(function(){location.reload()},1e3)):i.showError(s.message||"Erreur lors de l'application")}).fail(function(s){i.showError(s.message||"Erreur de connexion au serveur")})},getStatusBadge:function(s){return'<span class="ai-status-badge ai-status-'+s+'">'+({pending:"‚è≥",processing:"üîÑ",completed:"‚úÖ",failed:"‚ùå",applied:"‚úì"}[s]||"‚ùì")+" "+({pending:"En attente",processing:"En cours",completed:"Termin√©",failed:"√âchou√©",applied:"Appliqu√©"}[s]||s)+"</span>"},createInlineProgress:function(s){var e=l("#"+s);return e.length?(e.html('<div class="ai-progress-inline"><div class="spinner-small"></div><span class="inline-status">√âvaluation en cours...</span></div>'),{update:function(s){e.find(".inline-status").text(s)},complete:function(s){e.html(s)},error:function(s){e.html('<span class="ai-status-badge ai-status-failed">‚ùå '+s+"</span>")}}):null}}});