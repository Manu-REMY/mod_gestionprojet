define(["jquery","mod_gestionprojet/autosave","core/str","core/notification","core/ajax"],function(h,o,t,e,l){return{init:function(t){var e=t.cmid,r=t.autosaveInterval,i=t.groupid,s=t.isLocked,n=t.strings||{};h("#besoinEleveForm textarea").on("input",function(){u()});function w(t,e){if(!t)return[""];t=t.split(" ");let r=[],i="";return t.forEach(t=>{(i+t).length<=e?i+=(i?" ":"")+t:(i&&r.push(i),i=t)}),i&&r.push(i),r}function u(){let d=document.getElementById("beteACorneCanvas");if(d){var t=d.clientWidth||800,e=(d.innerHTML="",d.setAttribute("viewBox","0 0 "+t+" 500"),document.createElementNS("http://www.w3.org/2000/svg","defs")),r=document.createElementNS("http://www.w3.org/2000/svg","marker"),b=(r.setAttribute("id","arrowhead"),r.setAttribute("markerWidth","10"),r.setAttribute("markerHeight","10"),r.setAttribute("refX","9"),r.setAttribute("refY","3"),r.setAttribute("orient","auto"),document.createElementNS("http://www.w3.org/2000/svg","path")),b=(b.setAttribute("d","M0,0 L0,6 L9,3 z"),b.setAttribute("fill","#e91e63"),r.appendChild(b),e.appendChild(r),d.appendChild(e),t/2),r=250,e=90,t=h("#aqui").val()||"",c=h("#surquoi").val()||"",a=h("#dansquelbut").val()||"";let i=125+(b-160-125);var A=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),A=(A.setAttribute("cx",i),A.setAttribute("cy",115),A.setAttribute("rx",125),A.setAttribute("ry",45),A.setAttribute("fill","white"),A.setAttribute("stroke","#4fc3f7"),A.setAttribute("stroke-width","2.5"),d.appendChild(A),w(t,30));let s=115-8*A.length;A.forEach((t,e)=>{var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",i),r.setAttribute("y",s+18*e),r.setAttribute("text-anchor","middle"),r.setAttribute("fill","#555"),r.setAttribute("font-size","13"),r.textContent=t,d.appendChild(r)});t=document.createElementNS("http://www.w3.org/2000/svg","text"),A=(t.setAttribute("x",i),t.setAttribute("y",45),t.setAttribute("text-anchor","middle"),t.setAttribute("fill","#333"),t.setAttribute("font-size","15"),t.setAttribute("font-weight","700"),t.textContent="À qui le produit rend-il service ?",d.appendChild(t),document.createElementNS("http://www.w3.org/2000/svg","text")),t=(A.setAttribute("x",i),A.setAttribute("y",62),A.setAttribute("text-anchor","middle"),A.setAttribute("fill","#666"),A.setAttribute("font-size","12"),A.textContent="(utilisateur)",d.appendChild(A),160+b-125);let n=125+t;A=document.createElementNS("http://www.w3.org/2000/svg","ellipse"),t=(A.setAttribute("cx",n),A.setAttribute("cy",115),A.setAttribute("rx",125),A.setAttribute("ry",45),A.setAttribute("fill","white"),A.setAttribute("stroke","#4fc3f7"),A.setAttribute("stroke-width","2.5"),d.appendChild(A),w(c,30));let u=115-8*t.length;t.forEach((t,e)=>{var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",n),r.setAttribute("y",u+18*e),r.setAttribute("text-anchor","middle"),r.setAttribute("fill","#555"),r.setAttribute("font-size","13"),r.textContent=t,d.appendChild(r)});A=document.createElementNS("http://www.w3.org/2000/svg","text"),c=(A.setAttribute("x",n),A.setAttribute("y",45),A.setAttribute("text-anchor","middle"),A.setAttribute("fill","#333"),A.setAttribute("font-size","15"),A.setAttribute("font-weight","700"),A.textContent="Sur quoi agit-il ?",d.appendChild(A),document.createElementNS("http://www.w3.org/2000/svg","text")),t=(c.setAttribute("x",n),c.setAttribute("y",62),c.setAttribute("text-anchor","middle"),c.setAttribute("fill","#666"),c.setAttribute("font-size","12"),c.textContent="(matière d'œuvre)",d.appendChild(c),b-110),A=document.createElementNS("http://www.w3.org/2000/svg","rect"),c=(A.setAttribute("x",t),A.setAttribute("y",185),A.setAttribute("width",220),A.setAttribute("height",110),A.setAttribute("rx","25"),A.setAttribute("fill","#667eea"),A.setAttribute("stroke","#764ba2"),A.setAttribute("stroke-width","2.5"),d.appendChild(A),document.createElementNS("http://www.w3.org/2000/svg","text")),t=(c.setAttribute("x",b),c.setAttribute("y",232),c.setAttribute("text-anchor","middle"),c.setAttribute("fill","white"),c.setAttribute("font-size","20"),c.setAttribute("font-weight","bold"),c.textContent="Produit",d.appendChild(c),document.createElementNS("http://www.w3.org/2000/svg","text")),A=(t.setAttribute("x",b),t.setAttribute("y",252),t.setAttribute("text-anchor","middle"),t.setAttribute("fill","white"),t.setAttribute("font-size","14"),t.textContent="(objet technique)",d.appendChild(t),b-125);let o=125+A;c=document.createElementNS("http://www.w3.org/2000/svg","rect"),t=(c.setAttribute("x",A),c.setAttribute("y",360),c.setAttribute("width",r),c.setAttribute("height",e),c.setAttribute("rx","10"),c.setAttribute("fill","white"),c.setAttribute("stroke","#4fc3f7"),c.setAttribute("stroke-width","2.5"),d.appendChild(c),w(a,30));let l=405-8*t.length;t.forEach((t,e)=>{var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",o),r.setAttribute("y",l+18*e),r.setAttribute("text-anchor","middle"),r.setAttribute("fill","#555"),r.setAttribute("font-size","13"),r.textContent=t,d.appendChild(r)});A=document.createElementNS("http://www.w3.org/2000/svg","text"),r=(A.setAttribute("x",o),A.setAttribute("y",470),A.setAttribute("text-anchor","middle"),A.setAttribute("fill","#333"),A.setAttribute("font-size","15"),A.setAttribute("font-weight","700"),A.textContent="Dans quel but ?",d.appendChild(A),document.createElementNS("http://www.w3.org/2000/svg","text")),e=(r.setAttribute("x",o),r.setAttribute("y",487),r.setAttribute("text-anchor","middle"),r.setAttribute("fill","#666"),r.setAttribute("font-size","12"),r.textContent="(fonction d'usage ou besoin)",d.appendChild(r),125+i-10),c=n-125+10,a=b,t=document.createElementNS("http://www.w3.org/2000/svg","path"),A=(t.setAttribute("d","M "+e+" 115 Q "+a+" 190 "+c+" 115"),t.setAttribute("stroke","#e91e63"),t.setAttribute("stroke-width","3"),t.setAttribute("fill","none"),d.appendChild(t),document.createElementNS("http://www.w3.org/2000/svg","circle")),r=(A.setAttribute("cx",e),A.setAttribute("cy",115),A.setAttribute("r","5"),A.setAttribute("fill","#e91e63"),d.appendChild(A),document.createElementNS("http://www.w3.org/2000/svg","circle")),a=(r.setAttribute("cx",c),r.setAttribute("cy",115),r.setAttribute("r","5"),r.setAttribute("fill","#e91e63"),d.appendChild(r),b),t=o,e=80+b,A=60+o,c=document.createElementNS("http://www.w3.org/2000/svg","path"),r=(c.setAttribute("d","M "+a+" 305 C "+e+" 310, "+A+" 320, "+t+" 355"),c.setAttribute("stroke","#e91e63"),c.setAttribute("stroke-width","3"),c.setAttribute("fill","none"),c.setAttribute("marker-end","url(#arrowhead)"),d.appendChild(c),document.createElementNS("http://www.w3.org/2000/svg","circle"));r.setAttribute("cx",a),r.setAttribute("cy",305),r.setAttribute("r","5"),r.setAttribute("fill","#e91e63"),d.appendChild(r)}}h("#submitButton").on("click",function(){confirm(n.confirm_submission)&&l.call([{methodname:"mod_gestionprojet_submit_step",args:{cmid:e,step:7,action:"submit"}}])[0].done(function(t){t.success?window.location.reload():alert("Error submitting")}).fail(function(t){console.error("Submission error",t)})}),h("#revertButton").on("click",function(){confirm(n.confirm_revert)&&l.call([{methodname:"mod_gestionprojet_submit_step",args:{cmid:e,step:7,action:"revert"}}])[0].done(function(t){t.success?window.location.reload():alert("Error reverting")}).fail(function(t){console.error("Revert error",t)})}),s||o.init({cmid:e,step:7,groupid:i,interval:r,formSelector:"#besoinEleveForm",serialize:function(){var t={};return h("#besoinEleveForm textarea").each(function(){this.name&&(t[this.name]=this.value)}),t}}),u()}}});